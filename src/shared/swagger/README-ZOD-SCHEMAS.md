# Auto-Generating OpenAPI Schemas from Zod

This directory contains the infrastructure for automatically generating OpenAPI 3.0 schemas from Zod validation schemas used throughout the API.

## Overview

Instead of manually maintaining OpenAPI schemas in `openapi-spec.ts` that duplicate the Zod validation schemas in controllers, we use `@asteasolutions/zod-to-openapi` to auto-generate OpenAPI schemas directly from Zod definitions.

## Setup

### 1. Install Dependencies

```bash
npm install @asteasolutions/zod-to-openapi
```

### 2. File Structure

- **`zod-schemas.ts`** - Registers Zod schemas and generates OpenAPI components
- **`openapi-spec.ts`** - Main OpenAPI spec that merges auto-generated schemas
- **`swagger.ts`** - Mounts Swagger UI at `/api-docs`

## How It Works

### 1. Define Zod Schema in Controller

```typescript
// src/domains/services/service-request.controller.ts
import { z } from 'zod';

const submitRequestSchema = z.object({
  serviceId: z.string().min(1),
  propertyType: z.string().min(1),
  // ... more fields
});

router.post('/', authorize('customer'), async (req, res) => {
  const input = submitRequestSchema.parse(req.body);
  // ... handle request
});
```

### 2. Register Schema in `zod-schemas.ts`

```typescript
// src/shared/swagger/zod-schemas.ts
import { extendZodWithOpenApi } from '@asteasolutions/zod-to-openapi';
import { z } from 'zod';

extendZodWithOpenApi(z);

const submitRequestSchema = registry.register(
  'SubmitServiceRequest',  // OpenAPI schema name
  z.object({
    serviceId: z.string().min(1).openapi({
      description: 'Unique identifier of the service definition',
      example: 'svc_123abc',
    }),
    propertyType: z.string().min(1).openapi({
      description: 'Type of property',
      example: 'residential',
    }),
    // ... more fields with .openapi() decorators
  }).openapi({
    description: 'Request body for submitting a new service request',
  })
);
```

### 3. Auto-Merge into OpenAPI Spec

The `generateZodSchemas()` function in `zod-schemas.ts` is called by `openapi-spec.ts` to automatically merge all registered schemas:

```typescript
// openapi-spec.ts
export const openApiSpec = {
  ...baseOpenApiSpec,
  components: {
    ...baseOpenApiSpec.components,
    schemas: {
      ...baseOpenApiSpec.components.schemas,
      ...generateZodSchemas(),  // Auto-generated schemas merged here
    },
  },
};
```

### 4. Reference in API Routes

In `openapi-spec.ts` paths, reference the auto-generated schemas:

```typescript
paths: {
  '/api/v1/service-requests': {
    post: {
      requestBody: {
        content: {
          'application/json': {
            schema: { $ref: '#/components/schemas/SubmitServiceRequest' }
          }
        }
      },
      responses: {
        '201': {
          content: {
            'application/json': {
              schema: { $ref: '#/components/schemas/ServiceRequestResponse' }
            }
          }
        },
        '400': {
          content: {
            'application/json': {
              schema: { $ref: '#/components/schemas/ValidationErrorResponse' }
            }
          }
        }
      }
    }
  }
}
```

## Adding New Schemas

### Step 1: Create Zod Schema in Controller

```typescript
// src/domains/dealers/dealer.controller.ts
const createDealerSchema = z.object({
  fullName: z.string().min(2),
  phone: z.string().regex(/^\+?[1-9]\d{9,14}$/),
  cityId: z.string().uuid(),
});
```

### Step 2: Register in `zod-schemas.ts`

```typescript
// Add to zod-schemas.ts
const createDealerSchema = registry.register(
  'CreateDealer',
  z.object({
    fullName: z.string().min(2).openapi({
      description: 'Full name of the dealer',
      example: 'Rajesh Kumar',
    }),
    phone: z.string().regex(/^\+?[1-9]\d{9,14}$/).openapi({
      description: 'Phone number with optional country code',
      example: '+919876543210',
    }),
    cityId: z.string().uuid().openapi({
      description: 'City UUID where dealer operates',
      example: 'c7b3d8e0-5e0b-4b0f-8b3a-3b9f4b3d3b3d',
    }),
  }).openapi({
    description: 'Request body for creating a new dealer',
  })
);
```

### Step 3: Update `autoGeneratedSchemaNames` Array

```typescript
export const autoGeneratedSchemaNames = [
  'SubmitServiceRequest',
  'AddService',
  // ... existing schemas
  'CreateDealer',  // Add new schema name
];
```

### Step 4: Use in API Path Definition

The schema is now available at `#/components/schemas/CreateDealer`.

## Benefits

1. **Single Source of Truth**: Validation logic and API docs come from the same Zod schema
2. **Type Safety**: TypeScript types and OpenAPI schemas stay in sync
3. **Less Maintenance**: No need to manually update OpenAPI schemas when validation changes
4. **Consistency**: All validation errors follow the same structure across the API
5. **Rich Metadata**: Add descriptions, examples, and constraints using `.openapi()` decorators

## Currently Auto-Generated Schemas

- **`SubmitServiceRequest`** - POST /api/v1/service-requests body
- **`AddService`** - POST /api/v1/service-requests/:id/add-service body
- **`ServiceRequestResponse`** - Service request creation response
- **`ServiceRequestListItem`** - Single item in paginated service request list
- **`ValidationErrorResponse`** - Standard validation error response from validate middleware
- **`ValidationErrorDetail`** - Individual validation error details
- **`PaginationMeta`** - Pagination metadata for list endpoints

## Next Steps

To extend this system, register Zod schemas from:

1. `src/domains/auth/auth.validation.ts` - Auth schemas (login, signup, password reset)
2. `src/domains/dealers/dealers.validation.ts` - Dealer KYC, registration, commission schemas
3. `src/domains/payments/payment.validation.ts` - Payment initiation, refund, credit schemas
4. `src/domains/builders/builders.validation.ts` - Builder registration, project creation schemas
5. `src/domains/support/support.validation.ts` - Support ticket creation, update schemas

Each registered schema automatically appears in Swagger UI at `/api-docs`.

## Troubleshooting

### Schema Not Appearing in Swagger

1. Check that the schema is registered with `registry.register()`
2. Verify `generateZodSchemas()` is called in `openapi-spec.ts`
3. Restart the server to reload the OpenAPI spec
4. Check browser console for errors at `/api-docs`

### Type Errors with `.openapi()`

Make sure you've called `extendZodWithOpenApi(z)` at the top of `zod-schemas.ts`.

### Schema Conflicts

If a schema name already exists in `baseOpenApiSpec.components.schemas`, the auto-generated version will override it. Choose unique names or rename the manual schema.

## References

- [zod-to-openapi Documentation](https://github.com/asteasolutions/zod-to-openapi)
- [Zod Documentation](https://zod.dev/)
- [OpenAPI 3.0 Specification](https://swagger.io/specification/)
